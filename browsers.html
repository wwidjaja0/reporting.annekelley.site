<!doctype html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browsers and Errors Report</title>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
    <script src="https://cdn.zingchart.com/zingchart.min.js" defer></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
            Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            margin: 1rem 2rem;
            background: #f9f9f9;
            color: #333;
        }
        h1 {
            font-size: 2.25rem;
            margin-bottom: 0.25rem;
        }
        a {
            color: #2176ff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        section {
            background: #eee;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            padding: 2rem 2.5rem;
            margin-top: 2rem;
            max-width: 960px;
            margin-left: auto;
            margin-right: auto;
        }
        section > h2 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .intro, .section-content {
            font-size: 1.125rem;
            width: 100%; /* Fills the card horizontally */
            max-width: none; /* Remove max width restriction */
            margin-bottom: 1rem;
            margin-left: auto;
            margin-right: auto;
        }
        .datacontent {
            padding: 0;
            background: none;
            box-shadow: none;
        }
        .grid-card {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.25);
            padding: 1rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }
        .barchart-card {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.10);
            width: 100%;
            height: 400px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <h1>reporting.annekelley.site Browsers and Errors Report</h1>

    <nav style="margin-top:0.5rem;">
        <a href="/index.html">Dashboard</a> ·
        <a href="/static.html">Static Report</a> ·
        <a href="/dynamic.html">Dynamic Report</a> ·
        <a href="/langs.html">Languages Report</a>
    </nav>

    <!-- SECTION: Question -->
    <section aria-label="Report Question">
        <h2>Question</h2>
        <div class="section-content">
            Are users experiencing a significant number of errors because we are not supporting enough browser types?
        </div>
    </section>

    <!-- SECTION: Data -->
    <section aria-label="Error Data" class="datacontent">
        <h2>Data</h2>
        <div class="section-content">
            We begin by considering the errors our users encounter and how prevelant each one is.
        </div>
        <!-- Data grid card below -->
        <div class="grid-card">
            <h3 style="margin-top: 0;">Error Message Counts</h3>
            <div id="errorMessageGrid" style="width: 100%;"></div>
        </div>
    </section>

    <!-- SECTION: Discussion -->
    <section aria-label="Data Discussion">
        <h2>Discussion</h2>
        <div class="section-content">
            The most common error, "Failed to load resource: net::ERR_BLOCKED_BY_CLIENT", is a Chrome-centric error. Given the popularity of Chrome browsers, we would expect the most frequent error to be from Chrome. The next most occurring error, "A Problem Repeatedly Occurred", is specific to Safari. It is a little troubling that the number of occurrences for the Safari error is more than half that of the top error. In general, we could expect the number of Safari users to be far less than half of the number of Chrome users, so it seems that our error rates may not be proportional.
        </div>
    </section>

    <!-- SECTION: Exploration -->
    <section aria-label="Data Exploration">
        <h2>Exploration</h2>
        <div class="section-content">
            To see if we need to redesign to better support Safari browsers, we turn to our data. We want to know if the number of Safari users is indeed less than half of the Chrome users, which would suggest an imbalance in errors between the browser types.
        </div>
        <!-- User Agent Stacked Bar Chart -->
        <div class="barchart-card">
            <div id="userAgentBar"></div>
        </div>
    </section>

    <!-- SECTION: Action -->
    <section aria-label="Recommended Action">
        <h2>Action</h2>
        <div class="section-content">
            The Safari browser demographic is certainly less than half the size of the Chrome demographic. As a result, we see that Safari browsers are more inclined to experience errors on our web pages. Given that Safari browsers are still a noticeable population among our users, we need to invest in their experience. I recommend updating our code to work well on both Chrome and Safari, so that we don't drive away our Safari visitors with our poor performance.
        </div>
    </section>

    <script type="module">
        ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];
        async function renderChart() {
        try {
                const resp = await fetch('/endpoint.php/reports/browser-types');
            const userAgentData = await resp.json();
            const browsers = ["Chrome", "Safari", "Firefox"];
            const platforms = ["Windows", "Mac", "iOS", "Linux"];
            const agg = {};
            platforms.forEach(platform => {
            agg[platform] = {};
            browsers.forEach(browser => agg[platform][browser] = 0);
            });
            userAgentData.forEach(row => {
            agg[row.platform][row.browser] += parseInt(row.count, 10);
            });
            const platformColors = {
            Windows: "#377eb8",
            Mac: "#4daf4a",
            iOS: "#e41a1c",
            Linux: "#984ea3"
            };
            const series = platforms.map(platform => ({
            text: platform,
            backgroundColor: platformColors[platform] || "#999",
            values: browsers.map(browser => agg[platform][browser])
            }));
            const barData = {
            type: "bar",
            stacked: true,
            legend: { align: "center", verticalAlign: "bottom" },
            scaleX: { labels: browsers },
            scaleY: {
                label: { text: "Number of Users" },
                item: { "font-size": "14px" }
            },
            plotarea: {
                margin: "60 40 55 60"
            },
            series: series
            };
            zingchart.render({ id: 'userAgentBar', data: barData, width: '100%', height: 380 });
        } catch (err) {
            console.error("Error rendering charts:", err);
        }
        }
        async function renderGrid() {
        try {
            const resp = await fetch('/endpoint.php/reports/error-messages');
            const data = await resp.json();
            data.forEach(row => { row.count = parseInt(row.count, 10); });
            const columns = [
            { index: 'message', header: 'Error Message', type: 'string', sortable: true },
            { index: 'count', header: 'Occurrences', type: 'number', sortable: true }
            ];
            const grid = document.createElement('zing-grid');
            grid.setAttribute('page-size', '20');
            grid.setAttribute('page-size-options', '10,20,50');
            grid.setAttribute('sort-on-load', 'true');
            grid.setAttribute('sort-column', 'count');
            grid.setAttribute('sort-direction', 'desc');
            grid.data = data;
            grid.columns = columns;
            document.getElementById('errorMessageGrid').appendChild(grid);
        } catch (error) {
            console.error('Error rendering Error Messages Grid:', error);
        }
        }
        renderChart();
        renderGrid();
    </script>
</body>
</html>