<!doctype html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visuals</title>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
    <script src="https://cdn.zingchart.com/zingchart.min.js" defer></script>
</head>

<body>
    <!-- ZingChart -->
    <style>
        :root{
            --card-bg: #eee;
            --card-radius: 1rem;
            --card-pad: 1rem;
            --page-pad: 1rem;
        }

        .top-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
            background: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.08);
            margin: 0.5rem 1rem 1rem 1rem;
        }
        .top-nav a { color: #2176ff; text-decoration:none; font-weight:600 }

        section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 1rem;
            padding: var(--page-pad);
            align-items: start;
        }

        /* Use semantic article containers for visualizations for better accessibility */
        .visual-card {
            background: var(--card-bg);
            border-radius: var(--card-radius);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.12);
            padding: var(--card-pad);
            min-height: 120px;
            display: block;
        }

        .section-title {
            margin: 1.25rem 0 0.25rem 0;
            font-size: 1.25rem;
        }

        .card-small { padding: 0.5rem; }
    </style>

    <h1>Dashboard</h1>
    <p>Hint: Try clicking on different things and using your mouse to navigate around the charts!</p>

    <nav class="top-nav" aria-label="Main Navigation">
        <a href="#static-data">Static Data</a>
        <a href="#dynamic-data">Dynamic Data</a>
        <a href="/browsers.html" target="_blank" rel="noopener">Full Reports</a>
        <span style="margin-left:auto;color:#666;font-size:0.95rem;">Quick glance dashboard</span>
    </nav>

    <h2 id="static-data" class="section-title"><a href="https://annekelley.site/static.html">annekelley.site</a> Static Data Report</h2>
    <section>
        <article id="acceptsCookies" class="visual-card" role="region" aria-labelledby="acceptsCookiesTitle">
            <h3 id="acceptsCookiesTitle">acceptsCookies</h3>
            <p>A <em>pie chart</em> displaying the % of users that accept cookies.</p>
        </article>
        <article id="allowsJavaScript" class="visual-card" role="region" aria-labelledby="allowsJavaScriptTitle">
            <h3 id="allowsJavaScriptTitle">allowsJavaScript</h3>
            <p>A <em>pie chart</em> displaying the % of users that allow JavaScript.</p>
        </article>
        <article id="userNetConnType" class="visual-card" role="region" aria-labelledby="userNetConnTypeTitle">
            <h3 id="userNetConnTypeTitle">userNetConnType</h3>
            <p>A <em>bar chart</em> displaying the most frequent network connection.</p>
        </article>
    </section>
    <h2 id="dynamic-data" class="section-title"><a href="https://annekelley.site/">annekelley.site</a> Dynamic Data Report</h2>
    <section>
        <article id="pageLoadTimeChart" class="visual-card" role="region" aria-labelledby="pageLoadTimeTotalTitle">
            <h3 id="pageLoadTimeTotalTitle">pageLoadTimeTotal</h3>
            <p>A <em>bar plot</em> displaying the quartiles of the total page load time across all pages.</p>
        </article>
        <article id="mouseScatterplotHome" class="visual-card" role="region" aria-labelledby="mouseScatterplotHomeTitle">
            <h3 id="mouseScatterplotHomeTitle">mouseScatterplot - Home Page</h3>
            <p>A <em>scatter plot</em> displaying the coordinates of mouse clicks across the homepage.</p>
        </article>
        <article id="mouseScatterplot404" class="visual-card" role="region" aria-labelledby="mouseScatterplot404Title">
            <h3 id="mouseScatterplot404Title">mouseScatterplot - 404 Page</h3>
            <p>A <em>scatter plot</em> displaying the coordinates of mouse clicks on the 404 page.</p>
        </article>
    </section>
    <script type="module">
        // Retrieves getData function, which requests columns from a table of the web_analytics DB
        import { getData, countKeyValue, count } from '/fetch.js';

        ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];

        // --- Utilities ---
        const mapYesNo = (counts = {}) => {
            const keys = Object.keys(counts || {});
            if (keys.length >= 2 && keys.includes('0') && keys.includes('1')) {
                return { No: counts['0'] || 0, Yes: counts['1'] || 0 };
            }
            return counts;
        };

        const computeStats = (values = []) => {
            const nums = (values || []).map(Number).filter(v => !Number.isNaN(v)).sort((a,b)=>a-b);
            const n = nums.length;
            if (n === 0) return null;
            const sum = nums.reduce((s,x)=>s+x,0);
            const mean = sum / n;
            const median = nums[Math.floor(n/2)];
            const Q1 = nums[Math.floor(n/4)];
            const Q3 = nums[Math.floor((3*n)/4)];
            const min = nums[0];
            const max = nums[n-1];
            const variance = nums.reduce((s,x)=>s+Math.pow(x-mean,2),0)/n;
            const std = Math.sqrt(variance);
            return { count: n, min, Q1, median, Q3, max, mean, std };
        };

        function createZingGrid(containerId, rows = [], columns = [], options = {}){
            const container = document.getElementById(containerId);
            if (!container) return null;
            try {
                const grid = document.createElement('zing-grid');
                if (options.pageSize) grid.setAttribute('page-size', String(options.pageSize));
                if (options.pageOptions) grid.setAttribute('page-size-options', options.pageOptions);
                if (options.sortOnLoad) grid.setAttribute('sort-on-load', String(options.sortOnLoad));
                if (options.sortColumn) grid.setAttribute('sort-column', options.sortColumn);
                if (options.sortDirection) grid.setAttribute('sort-direction', options.sortDirection);
                grid.data = rows;
                grid.columns = columns;
                container.innerHTML = '';
                container.appendChild(grid);
                return grid;
            } catch (err) {
                console.error('createZingGrid error:', err);
                return null;
            }
        }

        // --- Chart/Config generators ---
        function generateBarConfig(keyValuePairs = {}, otherOptions) {
            return {
                type: 'bar',
                plot: { showZero: true },
                scaleX: { values: Object.keys(keyValuePairs), item: { angle: -45 }, step: 1, 'items-overlap': true },
                series: [{ values: Object.values(keyValuePairs) }],
                otherOptions
            };
        }

        function generateNavPieConfig(keyValuePairs = {}, colors, otherOptions) {
            return {
                type: 'navpie',
                plot: { detach: true, valueBox: { text: '%t\n%npv%' }, tooltip: { text: '%npv%<br>Count: %v' } },
                series: Object.entries(keyValuePairs).map(([key, value]) => ({ text: key, values: [value] })),
                otherOptions
            };
        }

        function generateScatterPlot(clicks = [], otherOptions) {
            const scatterData = (clicks || []).map(item => [ parseInt(item.clientX, 10) || 0, parseInt(item.clientY, 10) || 0 ]);
            const maxX = Math.max(...scatterData.map(d => d[0]).filter(v => !isNaN(v)), 0);
            const maxY = Math.max(...scatterData.map(d => d[1]).filter(v => !isNaN(v)), 0);
            return {
                type: 'hscatter', backgroundColor: '#fff',
                plot: { marker: { type: 'circle', size: 4, backgroundColor: '#ff0000' }, tooltip: { text: 'Click at (%kvx, %kvy)' } },
                scaleX: { values: `0:${maxX}:${Math.round(maxX/10) || 1}`, visible: true },
                scaleY: { values: `0:${maxY}:${Math.round(maxY/10) || 1}`, visible: true },
                series: [{ values: scatterData }], otherOptions
            };
        }

        // --- Renderers ---
        function renderGridFromKeyValue(containerId, keyValuePairs){
            const rows = Object.entries(keyValuePairs || {}).map(([k,v]) => ({ key: k, value: Number(v) }));
            createZingGrid(containerId, rows, [ { index: 'key', header: 'Key', type: 'string' }, { index: 'value', header: 'Count', type: 'number' } ], { pageSize: 10, pageOptions: '5,10,20', sortOnLoad: true, sortColumn: 'value', sortDirection: 'desc' });
        }

        async function renderPageLoadBarChart() {
            try {
                const resp = await fetch('/endpoint.php/reports/total-page-load-times');
                const data = await resp.json();

                // Extracts labels and values
                const labels = data.map(row => row.filename);
                const values = data.map(row => parseFloat(row.avgLoadTime));

                const chartConfig = {
                    type: 'bar',
                    title: {
                        text: 'Average Total Page Load Time by Page (seconds)',
                        fontSize: 18,
                        fontWeight: 'bold',
                    },
                    scaleX: {
                        labels: labels,
                        label: { text: 'Page' },
                        item: { angle: -45, fontSize: 11, wrapText: true, maxWidth: 100 },
                    },
                    scaleY: {
                        label: { text: 'Load Time (seconds)' },
                        minValue: 0,
                        guide: { visible: true },
                        tick: {
                            step: 0.2,
                        },
                        markers: [
                            {
                                type: 'line',
                                range: [1, 1],
                                lineColor: 'red',
                                lineWidth: 2,
                                label: { text: 'Acceptable Threshold (1s)', color: 'red', bold: true, offsetY: -10 },
                                placement: 'back'
                            }
                        ]
                    },
                    plot: {
                        barWidth: '70%',
                        borderRadiusTopLeft: 3,
                        borderRadiusTopRight: 3,
                    },
                    series: [
                        {
                            values: values,
                            backgroundColor: '#377eb8'
                        }
                    ],
                    legend: {
                        visible: false
                    },
                    tooltip: {
                        text: '%t<br>Load Time: %v seconds',
                        fontSize: 14,
                    },
                    padding: '15 15 20 60'
                };

                zingchart.render({
                    id: 'pageLoadTimeChart',
                    data: chartConfig,
                    height: 450,
                    width: '100%'
                });
            } catch (error) {
                console.error('Error rendering page load time chart:', error);
            }
        }


        // --- Initialization ---
        async function init(){
            try {
                // Static stats
                const [acceptsCookiesKV, allowsJavaScriptKV, userNetConnTypeKV] = await Promise.all([
                    countKeyValue('static','acceptsCookies'),
                    countKeyValue('static','allowsJavaScript'),
                    countKeyValue('static','userNetConnType')
                ]);
                const colors = ['#CC0000', '#009900'];
                const acceptsCookiesConfig = generateNavPieConfig(mapYesNo(acceptsCookiesKV || {}), colors);
                const allowsJavaScriptConfig = generateNavPieConfig(mapYesNo(allowsJavaScriptKV || {}), colors);

                zingchart.render({ id: 'acceptsCookies', data: acceptsCookiesConfig, width: '100%' });
                zingchart.render({ id: 'allowsJavaScript', data: allowsJavaScriptConfig, width: '100%' });

                // userNetConnType as grid
                renderGridFromKeyValue('userNetConnType', userNetConnTypeKV || {});

                // Page load times
                renderPageLoadBarChart();

                // Activity / scatter plots
                const activityData = await getData('activity', ['eventType','clientX','clientY','url']);
                const homePageClicks = (activityData || []).filter(item => item.eventType === 'click' && (item.url === 'https://annekelley.site/index.html' || item.url === 'https://annekelley.site/'));
                const cgiPerlBinClicks = (activityData || []).filter(item => item.eventType === 'click' && String(item.url).includes('https://annekelley.site/cgi-bin/'));
                const page404Clicks = (activityData || []).filter(item => item.eventType === 'click' && item.url === 'https://annekelley.site/404.html');

                const scatterHomeConfig = generateScatterPlot(homePageClicks);
                const scatterCGIConfig = generateScatterPlot(cgiPerlBinClicks);
                const scatter404Config = generateScatterPlot(page404Clicks);

                zingchart.render({ id: 'mouseScatterplotHome', data: scatterHomeConfig, width: '100%' });
                zingchart.render({ id: 'mouseScatterplot404', data: scatter404Config, width: '100%' });

            } catch (err) {
                console.error('Dashboard initialization error:', err);
            }
        }

        // run init
        init();

    </script>
</body>

</html>