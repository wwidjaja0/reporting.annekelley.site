<!doctype html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visuals</title>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
    <script src="https://cdn.zingchart.com/zingchart.min.js" defer></script>
</head>

<body>
    <!-- ZingChart -->
    <style>
        :root{
            --card-bg: #fbfbfd;
            --card-radius: 0.9rem;
            --card-pad: 1rem;
            --page-pad: 1rem;
            --accent: #2176ff;
            --muted: #6b7280;
        }

        body{
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(180deg,#f6f7fb 0%, #ffffff 60%);
            color: #111827;
            margin: 0;
            padding: 1rem 0 3rem 0;
        }

        h1{ text-align: center; font-size: 2rem; margin: 0.5rem 0; }
        p.lead { text-align: center; color: var(--muted); margin-top: 0.25rem; }

        .top-nav {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.9);
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
            box-shadow: 0 6px 18px rgba(16,24,40,0.06);
            margin: 1rem auto;
            width: min(920px, calc(100% - 2rem));
        }
        .top-nav a { color: var(--accent); text-decoration:none; font-weight:600; padding: 0.35rem 0.6rem; border-radius: 0.5rem; }
        .top-nav a:hover { background: rgba(33,118,255,0.06); }

        main.container { width: min(1200px, calc(100% - 2rem)); margin: 0 auto; }

        section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            padding: 0.25rem 0;
            align-items: start;
        }

        /* Two-column layout on wider screens; if a section has an odd number of cards
           make the final card span both columns so it takes the full width. */
        @media (min-width: 780px) {
            section {
                grid-template-columns: repeat(2, 1fr);
            }
            /* selector: the last child in the section, when it's at an odd index (i.e. odd count) */
            section > .visual-card:last-child:nth-child(odd) {
                grid-column: 1 / -1;
            }
        }

        /* Use semantic article containers for visualizations for better accessibility */
        .visual-card {
            background: var(--card-bg);
            border-radius: var(--card-radius);
            box-shadow: 0 6px 20px rgba(15,23,42,0.06);
            padding: var(--card-pad);
            min-height: 140px;
            display: block;
            transition: transform .12s ease, box-shadow .12s ease;
        }
        .visual-card:hover{ transform: translateY(-6px); box-shadow: 0 12px 30px rgba(15,23,42,0.08); }

        .card-header{ display:flex; justify-content:space-between; align-items:center; gap:0.5rem; }
        .card-header h3{ margin:0; font-size:1.05rem; }
        .card-meta { color: var(--muted); font-size: 0.9rem; }
        .card-link { font-size: 0.85rem; color: var(--accent); text-decoration:none; font-weight:600 }

        .section-title { margin: 1.25rem 0 0.25rem 0; font-size: 1.25rem; }

        .small-grid { padding: 0.25rem; }
    </style>

    <main class="container">
    <h1>Dashboard</h1>
    <p class="lead">Interactive previews of the reports — click a title to open the full report.</p>

    <nav class="top-nav" aria-label="Main Navigation">
        <a href="/static.html" target="_self" rel="noopener">Static Report</a>
    <!-- Dynamic report removed -->
        <a href="/browsers.html" target="_self" rel="noopener">Browsers Report</a>
        <a href="/langs.html" target="_self" rel="noopener">Languages Report</a>
    </nav>

    <h2 id="static-data" class="section-title">reporting.annekelley.site Static Data Report</h2>
    <section>
        <article id="acceptsCookies" class="visual-card" role="region" aria-labelledby="acceptsCookiesTitle">
            <div class="card-header">
                <h3 id="acceptsCookiesTitle">acceptsCookies</h3>
                <a class="card-link" href="/static.html#acceptsCookies">View report ↗</a>
            </div>
            <p class="card-meta">Pie chart showing % of users that accept cookies.</p>
        </article>
        <article id="allowsJavaScript" class="visual-card" role="region" aria-labelledby="allowsJavaScriptTitle">
            <div class="card-header">
                <h3 id="allowsJavaScriptTitle">allowsJavaScript</h3>
                <a class="card-link" href="/static.html#allowsJavaScript">View report ↗</a>
            </div>
            <p class="card-meta">Pie chart showing % of users that allow JavaScript.</p>
        </article>
        <article id="userNetConnType" class="visual-card" role="region" aria-labelledby="userNetConnTypeTitle">
            <div class="card-header">
                <h3 id="userNetConnTypeTitle">userNetConnType</h3>
                <a class="card-link" href="/static.html#userNetConnType">View report ↗</a>
            </div>
            <p class="card-meta">Top network connection types (grid).</p>
            <div id="userNetConnTypePreview" class="small-grid" style="margin-top:0.75rem;"></div>
        </article>
    </section>

    <h2 id="browsers-previews" class="section-title">Browsers Report — Previews</h2>
    <section>
        <article id="userAgentBarCard" class="visual-card" role="region" aria-labelledby="userAgentBarTitle">
            <div class="card-header">
                <h3 id="userAgentBarTitle">Browser types (preview)</h3>
                <a class="card-link" href="/browsers.html">View Report ↗</a>
            </div>
            <p class="card-meta">Stacked bar by platform and browser (preview).</p>
            <div id="userAgentBar" style="width:100%; height:260px; margin-top:0.75rem;"></div>
        </article>

        <article id="errorMessageGridCard" class="visual-card" role="region" aria-labelledby="errorMessageGridTitle">
            <div class="card-header">
                <h3 id="errorMessageGridTitle">Error messages (preview)</h3>
                <a class="card-link" href="/browsers.html#errorMessageGrid">View Report ↗</a>
            </div>
            <p class="card-meta">Top error messages (small grid).</p>
            <div id="errorMessageGrid" class="small-grid"></div>
        </article>
    </section>

    <h2 id="langs-previews" class="section-title">Languages Report — Previews</h2>
    <section>
        <article id="userLangPieCard" class="visual-card" role="region" aria-labelledby="userLangPieTitle">
            <div class="card-header">
                <h3 id="userLangPieTitle">User languages (preview)</h3>
                <a class="card-link" href="/langs.html">View Report ↗</a>
            </div>
            <p class="card-meta">Language distribution (preview pie).</p>
            <div id="userLangPie" style="width:100%; height:240px; margin-top:0.75rem;"></div>
        </article>

        <article id="spanishVisitsGridCard" class="visual-card" role="region" aria-labelledby="spanishVisitsGridTitle">
            <div class="card-header">
                <h3 id="spanishVisitsGridTitle">Spanish visits (preview)</h3>
                <a class="card-link" href="/langs.html#spanishVisitsGrid">View Report ↗</a>
            </div>
            <p class="card-meta">Pages visited by Spanish speakers (small grid).</p>
            <div id="spanishVisitsGrid" class="small-grid"></div>
        </article>
    </section>
    </main>
    <script type="module">
        // Retrieves getData function, which requests columns from a table of the web_analytics DB
        import { getData, countKeyValue, count } from '/fetch.js';

        ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];

        // --- Utilities ---
        const mapYesNo = (counts = {}) => {
            const keys = Object.keys(counts || {});
            if (keys.length >= 2 && keys.includes('0') && keys.includes('1')) {
                return { No: counts['0'] || 0, Yes: counts['1'] || 0 };
            }
            return counts;
        };

        const computeStats = (values = []) => {
            const nums = (values || []).map(Number).filter(v => !Number.isNaN(v)).sort((a,b)=>a-b);
            const n = nums.length;
            if (n === 0) return null;
            const sum = nums.reduce((s,x)=>s+x,0);
            const mean = sum / n;
            const median = nums[Math.floor(n/2)];
            const Q1 = nums[Math.floor(n/4)];
            const Q3 = nums[Math.floor((3*n)/4)];
            const min = nums[0];
            const max = nums[n-1];
            const variance = nums.reduce((s,x)=>s+Math.pow(x-mean,2),0)/n;
            const std = Math.sqrt(variance);
            return { count: n, min, Q1, median, Q3, max, mean, std };
        };

        function createZingGrid(containerId, rows = [], columns = [], options = {}){
            const container = document.getElementById(containerId);
            if (!container) return null;
            try {
                const grid = document.createElement('zing-grid');
                if (options.pageSize) grid.setAttribute('page-size', String(options.pageSize));
                if (options.pageOptions) grid.setAttribute('page-size-options', options.pageOptions);
                if (options.sortOnLoad) grid.setAttribute('sort-on-load', String(options.sortOnLoad));
                if (options.sortColumn) grid.setAttribute('sort-column', options.sortColumn);
                if (options.sortDirection) grid.setAttribute('sort-direction', options.sortDirection);
                grid.data = rows;
                grid.columns = columns;
                container.innerHTML = '';
                container.appendChild(grid);
                return grid;
            } catch (err) {
                console.error('createZingGrid error:', err);
                return null;
            }
        }

        // --- Chart/Config generators ---
        function generateBarConfig(keyValuePairs = {}, otherOptions) {
            // if keys include Yes/No use green/red colors
            const values = Object.values(keyValuePairs);
            const keys = Object.keys(keyValuePairs);
            const series = [{ values }];
            if (keys.includes('Yes') || keys.includes('No')) {
                series[0].backgroundColor = keys.map(k => k === 'Yes' ? '#16a34a' : (k === 'No' ? '#dc2626' : '#6b7280'));
            }
            return { type: 'bar', plot: { showZero: true }, scaleX: { values: keys, item: { angle: -45 }, step: 1, 'items-overlap': true }, series, otherOptions };
        }

        function generateNavPieConfig(keyValuePairs = {}, otherOptions) {
            // color Yes/No specially
            const palette = { Yes: '#16a34a', No: '#dc2626' };
            return {
                type: 'navpie',
                plot: { detach: true, valueBox: { text: '%t\n%npv%' }, tooltip: { text: '%npv%<br>Count: %v' } },
                series: Object.entries(keyValuePairs).map(([key, value]) => ({ text: key, values: [value], backgroundColor: palette[key] || undefined })),
                otherOptions
            };
        }

        function generateScatterPlot(clicks = [], otherOptions) {
            const scatterData = (clicks || []).map(item => [ parseInt(item.clientX, 10) || 0, parseInt(item.clientY, 10) || 0 ]);
            const maxX = Math.max(...scatterData.map(d => d[0]).filter(v => !isNaN(v)), 0);
            const maxY = Math.max(...scatterData.map(d => d[1]).filter(v => !isNaN(v)), 0);
            return {
                type: 'hscatter', backgroundColor: '#fff',
                plot: { marker: { type: 'circle', size: 4, backgroundColor: '#ff0000' }, tooltip: { text: 'Click at (%kvx, %kvy)' } },
                scaleX: { values: `0:${maxX}:${Math.round(maxX/10) || 1}`, visible: true },
                scaleY: { values: `0:${maxY}:${Math.round(maxY/10) || 1}`, visible: true },
                series: [{ values: scatterData }], otherOptions
            };
        }

        // --- Renderers ---
        function renderGridFromKeyValue(containerId, keyValuePairs){
            const rows = Object.entries(keyValuePairs || {}).map(([k,v]) => ({ key: k, value: Number(v) }));
            createZingGrid(containerId, rows, [ { index: 'key', header: 'Key', type: 'string' }, { index: 'value', header: 'Count', type: 'number' } ], { pageSize: 10, pageOptions: '5,10,20', sortOnLoad: true, sortColumn: 'value', sortDirection: 'desc' });
        }


        // --- Initialization ---
        async function init(){
            try {
                // Static stats
                const [acceptsCookiesKV, allowsJavaScriptKV, userNetConnTypeKV] = await Promise.all([
                    countKeyValue('static','acceptsCookies'),
                    countKeyValue('static','allowsJavaScript'),
                    countKeyValue('static','userNetConnType')
                ]);
                const colors = ['#CC0000', '#009900'];
                const acceptsCookiesConfig = generateNavPieConfig(mapYesNo(acceptsCookiesKV || {}), colors);
                const allowsJavaScriptConfig = generateNavPieConfig(mapYesNo(allowsJavaScriptKV || {}), colors);

                zingchart.render({ id: 'acceptsCookies', data: acceptsCookiesConfig, width: '100%' });
                zingchart.render({ id: 'allowsJavaScript', data: allowsJavaScriptConfig, width: '100%' });

                // userNetConnType as grid (sorted, preview)
                renderGridFromKeyValue('userNetConnTypePreview', userNetConnTypeKV || {});

                // Activity / scatter plots
                const activityData = await getData('activity', ['eventType','clientX','clientY','url']);
                const homePageClicks = (activityData || []).filter(item => item.eventType === 'click' && (item.url === 'https://annekelley.site/index.html' || item.url === 'https://annekelley.site/'));
                const cgiPerlBinClicks = (activityData || []).filter(item => item.eventType === 'click' && String(item.url).includes('https://annekelley.site/cgi-bin/'));
                const page404Clicks = (activityData || []).filter(item => item.eventType === 'click' && item.url === 'https://annekelley.site/404.html');

                const scatterHomeConfig = generateScatterPlot(homePageClicks);
                const scatterCGIConfig = generateScatterPlot(cgiPerlBinClicks);
                const scatter404Config = generateScatterPlot(page404Clicks);

                zingchart.render({ id: 'mouseScatterplotHome', data: scatterHomeConfig, width: '100%' });
                zingchart.render({ id: 'mouseScatterplot404', data: scatter404Config, width: '100%' });

                // --- Browsers & Errors previews (small) ---
                try {
                    const resp = await fetch('/endpoint.php/reports/browser-types');
                    const userAgentData = await resp.json();
                    const browsers = [...new Set(userAgentData.map(r => r.browser))].sort();
                    const platforms = [...new Set(userAgentData.map(r => r.platform))].sort();
                    const agg = {};
                    platforms.forEach(platform => { agg[platform] = {}; browsers.forEach(b => agg[platform][b]=0); });
                    userAgentData.forEach(row => { agg[row.platform][row.browser] += parseInt(row.count,10); });
                    const platformColors = { Windows: "#377eb8", Mac: "#4daf4a", iOS: "#e41a1c", Linux: "#984ea3" };
                    const series = platforms.map(platform => ({ text: platform, backgroundColor: platformColors[platform] || "#999", values: browsers.map(browser => agg[platform][browser] || 0) }));
                    const barData = { type: 'bar', stacked: true, legend: { align: 'center', verticalAlign: 'bottom' }, scaleX: { labels: browsers }, series };
                    zingchart.render({ id: 'userAgentBar', data: barData, width: '100%', height: 260 });
                } catch (err) {
                    console.error('Browsers preview error:', err);
                }

                try {
                    // errors grid preview
                    const resp2 = await fetch('/endpoint.php/reports/error-messages');
                    const data2 = await resp2.json();
                    data2.forEach(row => { row.count = parseInt(row.count, 10); });
                    // show only top 10
                    const previewErr = data2.slice(0,10);
                    createZingGrid('errorMessageGrid', previewErr, [ { index: 'message', header: 'Error Message', type: 'string' }, { index: 'count', header: 'Occurrences', type: 'number' } ], { pageSize: 10, pageOptions: '5,10,20' });
                } catch (err) { console.error('Error preview grid:', err); }

                // --- Languages previews ---
                try {
                    const respL = await fetch('/endpoint.php/reports/user-langs');
                    const langData = await respL.json();
                    const pieLabels = langData.map(row => row.language);
                    const pieValues = langData.map(row => parseInt(row.count, 10));
                    const userLangColors = ["#27ae60", "#e74c3c", "#f5cba7", "#7f8c8d", "#16a085"];
                    const userLangPie = {
                        type: 'navpie', plot: { borderColor: '#fff', borderWidth: 2, valueBox: { placement: 'out', text: '%t (%npv%)' } },
                        series: pieLabels.map((label,i)=>({ text: label, values:[pieValues[i]], backgroundColor: userLangColors[i % userLangColors.length] }))
                    };
                    zingchart.render({ id: 'userLangPie', data: userLangPie, width: '100%', height: 240 });
                } catch (err) { console.error('User languages preview error:', err); }

                try {
                    const respS = await fetch('/endpoint.php/reports/spanish-pages');
                    const sdata = await respS.json();
                    sdata.forEach(row => { if (row.Visits) row.Visits = parseInt(row.Visits,10); });
                    createZingGrid('spanishVisitsGrid', sdata.slice(0,10), [ { index: 'FileName', header: 'File Name' }, { index: 'Visits', header: 'Visits', type: 'number' } ], { pageSize: 10, pageOptions: '5,10,20' });
                } catch (err) { console.error('Spanish visits preview error:', err); }

            } catch (err) {
                console.error('Dashboard initialization error:', err);
            }
        }

        // run init
        init();

    </script>
</body>

</html>