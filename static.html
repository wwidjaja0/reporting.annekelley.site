<!doctype html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Static Data Report</title>
    <script src="https://annekelley.site/collector.js"></script>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
    <script src="https://cdn.zingchart.com/zingchart.min.js" defer></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; margin: 1rem 2rem; background: #f9f9f9; color:#222 }
        h1{ font-size:1.8rem }
        a { color:#2176ff; text-decoration:none }
        section { background:#eee;border-radius:1rem;padding:1.5rem;margin-top:1.25rem;max-width:960px;margin-left:auto;margin-right:auto }
        .grid-card, .chart-card { background:#fff;border-radius:0.75rem;padding:1rem;box-shadow:0 0.5rem 1rem rgba(0,0,0,0.12);margin-top:1rem }
        .card-row { display:flex;gap:1rem;flex-wrap:wrap }
        .small-chart { width:320px; }
    </style>
</head>
<body>
    <h1><a href="/">reporting.annekelley.site</a> — Static Data Report</h1>
    <nav style="margin-top:0.5rem;">
        <a href="/index.html">Dashboard</a> ·
    <!-- Dynamic report removed -->
        <a href="/browsers.html">Browsers Report</a> ·
        <a href="/langs.html">Languages Report</a>
    </nav>

    <section aria-label="Static Data">
        <h2>Static indicators</h2>
        <div class="card-row">
            <div class="chart-card small-chart">
                <h3 id="acceptsCookiesTitle">acceptsCookies</h3>
                <div id="acceptsCookiesPreview" style="width:100%;height:220px"></div>
            </div>
            <div class="chart-card small-chart">
                <h3 id="allowsJavaScriptTitle">allowsJavaScript</h3>
                <div id="allowsJavaScriptPreview" style="width:100%;height:220px"></div>
            </div>
        </div>

        <div class="grid-card">
            <h3 id="userNetConnTypeTitle">userNetConnType</h3>
            <div id="netConnTypeGrid"></div>
        </div>
    </section>

    <script type="module">
        import { countKeyValue } from '/fetch.js';
        ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];

        function generateNavPieConfig(keyValuePairs = {}) {
            // map common Yes/No variants to colors
            const yesColor = '#16a34a';
            const noColor = '#dc2626';
            function colorForKey(k){
                const s = String(k).trim().toLowerCase();
                if (s === 'yes' || s === '1' || s === 'true') return yesColor;
                if (s === 'no' || s === '0' || s === 'false') return noColor;
                return undefined;
            }
            return {
                type: 'navpie',
                plot: { detach: true, valueBox: { text: '%t\n%npv%' }, tooltip: { text: '%npv%<br>Count: %v' } },
                series: Object.entries(keyValuePairs).map(([key, value]) => {
                    const c = colorForKey(key);
                    const item = { text: key, values: [value] };
                    if (c) { item['background-color'] = c; item.backgroundColor = c; }
                    return item;
                })
            };
        }

        async function renderNetConnTypeGrid() {
            try {
                const resp = await fetch('/endpoint.php/reports/avg-load-time-connection-type');
                const data = await resp.json();

                // Ensure numeric conversion
                data.forEach(row => {
                    row.count = parseInt(row.count, 10);
                    row.avgLoadTimeSec = parseFloat(row.avgLoadTimeSec);
                });

                const columns = [
                    { index: 'connectionType', header: 'Connection Type', type: 'string', sortable: true },
                    { index: 'avgLoadTimeSec', header: 'Average Load Time (s)', type: 'number', sortable: true, renderer: (val) => val.toFixed(3) },
                    { index: 'count', header: 'Count', type: 'number', sortable: true }
                ];

                const grid = document.createElement('zing-grid');
                grid.setAttribute('page-size', '20');
                grid.setAttribute('page-size-options', '10,20,50');
                grid.setAttribute('sort-on-load', 'true');
                grid.setAttribute('sort-column', 'count');
                grid.setAttribute('sort-direction', 'desc');
                grid.data = data;
                grid.columns = columns;

                document.getElementById('netConnTypeGrid').appendChild(grid);
            } catch (error) {
                console.error('Error rendering Connection Type Grid:', error);
            }
        }
        function createGrid(containerId, rows = [], columns = []){
            const container = document.getElementById(containerId);
            if (!container) return;
            const grid = document.createElement('zing-grid');
            grid.setAttribute('page-size', '10');
            grid.setAttribute('page-size-options', '5,10,20');
            grid.setAttribute('sort-on-load', 'true');
            // choose a sensible default sort column from provided columns (prefer numeric/count-like column)
            const defaultSortColumn = (Array.isArray(columns) && columns.length > 0)
                ? (columns.find(c => /count|value|visits|Visits|Count/i.test(String(c.index))) || columns[1] || columns[0]).index
                : 'value';
            grid.setAttribute('sort-column', String(defaultSortColumn));
            grid.setAttribute('sort-direction', 'desc');
            grid.data = rows;
            grid.columns = columns;
            container.innerHTML = '';
            container.appendChild(grid);
            // try to force a sort after the grid initializes (API may be available)
            try {
                // small delay to allow ZingGrid to initialize
                const _col = defaultSortColumn;
                setTimeout(() => {
                    if (typeof grid.sort === 'function') {
                        grid.sort(_col, 'desc');
                    } else if (grid.setAttribute) {
                        grid.setAttribute('sort-column', String(_col));
                        grid.setAttribute('sort-direction', 'desc');
                    }
                }, 50);
            } catch (e) { /* ignore */ }
        }

        // normalize keys like '0','1', 0,1, 'true','false' into 'Yes'/'No' labels and sum counts
        function normalizeYesNoKV(kv = {}){
            const out = {};
            Object.entries(kv || {}).forEach(([k,v]) => {
                const s = String(k).trim().toLowerCase();
                let label = k;
                if (s === '1' || s === 'true' || s === 'yes') label = 'Yes';
                else if (s === '0' || s === 'false' || s === 'no') label = 'No';
                const num = Number(v) || 0;
                out[label] = (out[label] || 0) + num;
            });
            return out;
        }

        async function renderPieCharts() {
            try {
                const [acceptsCookiesKV, allowsJavaScriptKV] = await Promise.all([
                    countKeyValue('static','acceptsCookies'),
                    countKeyValue('static','allowsJavaScript')
                ]);

                // Pie charts (normalize 0/1 -> Yes/No so labels and colors apply)
                const acceptsCfg = generateNavPieConfig(normalizeYesNoKV(acceptsCookiesKV || {}));
                const allowsCfg = generateNavPieConfig(normalizeYesNoKV(allowsJavaScriptKV || {}));
                zingchart.render({ id: 'acceptsCookiesPreview', data: acceptsCfg, width: '100%', height: 220 });
                zingchart.render({ id: 'allowsJavaScriptPreview', data: allowsCfg, width: '100%', height: 220 });

                // Grid: build rows and pre-sort by count (desc) so grid shows greatest-to-least
                let rows = Object.entries(userNetConnTypeKV || {}).map(([k,v]) => ({ connection: k, count: Number(v) }));
                rows = rows.sort((a,b) => (Number(b.count) || 0) - (Number(a.count) || 0));
                createGrid('userNetConnTypeGrid', rows, [ { index: 'connection', header: 'Connection Type' }, { index: 'count', header: 'Count', type: 'number' }]);
            } catch (err) {
                console.error('Static report render error:', err);
            }
        }

        renderNetConnTypeGrid();
        renderPieCharts();
    </script>
</body>
</html>
